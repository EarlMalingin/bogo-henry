<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Call Flow</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>Test Call Flow</h1>
    
    <div class="status disconnected" id="status">Disconnected</div>
    
    <div>
        <label>User ID: <input type="number" id="userId" value="3"></label><br><br>
        <label>User Type: 
            <select id="userType">
                <option value="tutor">Tutor</option>
                <option value="student">Student</option>
            </select>
        </label><br><br>
        <button class="button" onclick="connect()">Connect</button>
        <button class="button" onclick="disconnect()">Disconnect</button>
    </div>
    
    <div>
        <h3>Test Call</h3>
        <label>Receiver ID: <input type="number" id="receiverId" value="4"></label><br><br>
        <label>Receiver Type: 
            <select id="receiverType">
                <option value="student">Student</option>
                <option value="tutor">Tutor</option>
            </select>
        </label><br><br>
        <button class="button" onclick="testCall()">Test Call Initiation</button>
    </div>
    
    <div>
        <h3>Event Log</h3>
        <button class="button" onclick="clearLog()">Clear Log</button>
        <div class="log" id="log"></div>
    </div>
    
    <script>
        let socket = null;
        let isConnected = false;
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateStatus(connected) {
            const statusElement = document.getElementById('status');
            if (connected) {
                statusElement.className = 'status connected';
                statusElement.textContent = 'Connected';
            } else {
                statusElement.className = 'status disconnected';
                statusElement.textContent = 'Disconnected';
            }
        }
        
        function connect() {
            const userId = parseInt(document.getElementById('userId').value);
            const userType = document.getElementById('userType').value;
            
            log(`Connecting as ${userType} ${userId}...`);
            
            socket = io('http://localhost:3001', {
                transports: ['websocket', 'polling'],
                timeout: 20000
            });
            
            socket.on('connect', () => {
                log('Connected to socket server');
                isConnected = true;
                updateStatus(true);
                
                // Authenticate user
                log(`Authenticating as ${userType} ${userId}...`);
                socket.emit('authenticate', {
                    userId: userId,
                    userType: userType
                });
            });
            
            socket.on('authenticated', (data) => {
                log(`Authentication confirmed: ${JSON.stringify(data)}`);
            });
            
            socket.on('disconnect', () => {
                log('Disconnected from socket server');
                isConnected = false;
                updateStatus(false);
            });
            
            socket.on('connect_error', (error) => {
                log(`Connection error: ${error.message}`);
                isConnected = false;
                updateStatus(false);
            });
            
            // Listen for incoming calls
            socket.on('incoming_call', (data) => {
                log(`INCOMING CALL RECEIVED: ${JSON.stringify(data)}`);
                alert(`Incoming ${data.callType} call from ${data.callerName}!`);
            });
        }
        
        function testCall() {
            if (!isConnected) {
                log('Not connected to socket server');
                return;
            }
            
            const userId = parseInt(document.getElementById('userId').value);
            const userType = document.getElementById('userType').value;
            const receiverId = parseInt(document.getElementById('receiverId').value);
            const receiverType = document.getElementById('receiverType').value;
            
            const callData = {
                roomId: 'test_room_' + Date.now(),
                callType: 'video',
                callerId: userId,
                callerName: `${userType.charAt(0).toUpperCase() + userType.slice(1)} ${userId}`,
                receiverId: receiverId,
                receiverType: receiverType,
                callerType: userType
            };
            
            log(`Testing call initiation: ${JSON.stringify(callData)}`);
            socket.emit('call_initiated', callData);
        }
        
        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                isConnected = false;
                updateStatus(false);
                log('Disconnected');
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Auto-connect when page loads
        window.addEventListener('load', () => {
            log('Page loaded, ready to test call flow');
        });
    </script>
</body>
</html>
