<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Tutor Call</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Debug Tutor Call System</h1>
    
    <div class="status disconnected" id="status">Disconnected</div>
    
    <div>
        <label>Tutor ID: <input type="number" id="tutorId" value="1"></label><br><br>
        <label>Student ID: <input type="number" id="studentId" value="2"></label><br><br>
        <button onclick="connect()">Connect as Tutor</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="initiateCall()">Initiate Video Call</button>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        let socket = null;
        let isConnected = false;
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateStatus(connected) {
            const statusElement = document.getElementById('status');
            if (connected) {
                statusElement.className = 'status connected';
                statusElement.textContent = 'Connected';
            } else {
                statusElement.className = 'status disconnected';
                statusElement.textContent = 'Disconnected';
            }
        }
        
        function connect() {
            const tutorId = parseInt(document.getElementById('tutorId').value);
            
            log(`Connecting as tutor ${tutorId}...`);
            
            socket = io('http://localhost:3001', {
                transports: ['websocket', 'polling'],
                timeout: 20000
            });
            
            socket.on('connect', () => {
                log('Connected to socket server');
                isConnected = true;
                updateStatus(true);
                
                // Authenticate as tutor
                log(`Authenticating as tutor ${tutorId}...`);
                socket.emit('authenticate', {
                    userId: tutorId,
                    userType: 'tutor'
                });
            });
            
            socket.on('authenticated', (data) => {
                log(`Authentication confirmed: ${JSON.stringify(data)}`);
            });
            
            socket.on('disconnect', () => {
                log('Disconnected from socket server');
                isConnected = false;
                updateStatus(false);
            });
            
            socket.on('connect_error', (error) => {
                log(`Connection error: ${error.message}`);
                isConnected = false;
                updateStatus(false);
            });
        }
        
        function initiateCall() {
            if (!isConnected) {
                log('Not connected to socket server');
                return;
            }
            
            const tutorId = parseInt(document.getElementById('tutorId').value);
            const studentId = parseInt(document.getElementById('studentId').value);
            
            const callData = {
                roomId: 'test_room_' + Date.now(),
                callType: 'video',
                callerId: tutorId,
                callerName: 'Test Tutor',
                receiverId: studentId,
                receiverType: 'student'
            };
            
            log(`Initiating call: ${JSON.stringify(callData)}`);
            socket.emit('call_initiated', callData);
        }
        
        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                isConnected = false;
                updateStatus(false);
                log('Disconnected');
            }
        }
        
        // Auto-connect when page loads
        window.addEventListener('load', () => {
            log('Page loaded, ready to test tutor call system');
        });
    </script>
</body>
</html>
